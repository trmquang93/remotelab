<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=overlays-content">
  <title>{{FOLDER_PATH_HTML}} // Remote</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
  <style nonce="{{NONCE}}">
    :root {
      --terminal-green: #00ff41;
      --terminal-cyan: #00ffff;
      --terminal-amber: #ffb000;
      --terminal-red: #ff0000;
      --bg-black: #0a0a0a;
      --bg-dark: #121212;
      --bg-darker: #0d0d0d;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-black);
      color: var(--terminal-green);
      overflow: hidden;
      height: 100vh;
      height: 100dvh;
    }

    .toolbar {
      background: var(--bg-dark);
      border-bottom: 2px solid var(--terminal-green);
      padding: 12px 20px;
      padding-top: max(12px, env(safe-area-inset-top));
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 12px;
      height: 50px;
    }

    .back-btn {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--terminal-green);
      color: var(--terminal-green);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .back-btn:hover {
      background: var(--terminal-green);
      color: var(--bg-black);
    }

    .folder-path {
      flex: 1;
      color: var(--terminal-cyan);
      font-weight: 700;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .toolbar-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .toolbar-btn {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--terminal-green);
      color: var(--terminal-green);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.2s;
    }

    .toolbar-btn:hover {
      background: var(--terminal-green);
      color: var(--bg-black);
    }

    .toolbar-btn.active {
      background: var(--terminal-green);
      color: var(--bg-black);
    }

    .toolbar-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Tab bar */
    .tab-bar {
      background: var(--bg-darker);
      border-bottom: 1px solid rgba(0, 255, 65, 0.2);
      display: flex;
      align-items: stretch;
      height: 40px;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .tab-bar::-webkit-scrollbar { display: none; }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 16px;
      font-size: 12px;
      color: rgba(0, 255, 65, 0.6);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      transition: color 0.15s, border-color 0.15s, background 0.15s;
      flex-shrink: 0;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .tab:hover {
      color: var(--terminal-green);
      background: rgba(0, 255, 65, 0.03);
    }

    .tab.active {
      color: var(--terminal-green);
      border-bottom-color: var(--terminal-green);
      background: rgba(0, 255, 65, 0.05);
    }

    .tab .tab-badge {
      padding: 1px 5px;
      border: 1px solid var(--terminal-amber);
      color: var(--terminal-amber);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .tab .tab-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      font-size: 14px;
      color: rgba(0, 255, 65, 0.4);
      border-radius: 3px;
      transition: color 0.15s, background 0.15s;
    }

    .tab .tab-close:hover {
      color: var(--terminal-red);
      background: rgba(255, 0, 0, 0.15);
    }

    .new-tab-wrapper {
      position: relative;
      flex-shrink: 0;
      display: flex;
      align-items: center;
    }

    .new-tab-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 0 14px;
      height: 100%;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: rgba(0, 255, 65, 0.5);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: color 0.15s;
      white-space: nowrap;
    }

    .new-tab-btn:hover {
      color: var(--terminal-green);
    }

    .new-tab-dropdown {
      display: none;
      position: fixed;
      background: var(--bg-dark);
      border: 1px solid var(--terminal-green);
      min-width: 180px;
      z-index: 100;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    }

    .new-tab-dropdown.open { display: block; }

    .new-tab-option {
      display: block;
      width: 100%;
      padding: 10px 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--terminal-green);
      background: transparent;
      border: none;
      text-align: left;
      cursor: pointer;
      transition: background 0.15s;
    }

    .new-tab-option:hover {
      background: rgba(0, 255, 65, 0.1);
    }

    .new-tab-option .option-label {
      color: var(--terminal-amber);
      font-size: 10px;
      text-transform: uppercase;
      margin-left: 8px;
    }

    /* Main layout */
    .main-container {
      display: grid;
      grid-template-columns: 1fr 6px var(--diff-panel-width, 600px);
      height: calc(100vh - 90px);
      height: calc(100dvh - 90px);
      position: relative;
    }

    .main-container.collapsed {
      grid-template-columns: 1fr 0 0;
    }

    .drag-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      cursor: col-resize;
    }

    .terminal-panel {
      background: var(--bg-black);
      overflow: hidden;
      position: relative;
    }

    .terminal-iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: none;
    }

    .terminal-iframe.active {
      display: block;
    }

    .divider {
      background: var(--terminal-green);
      cursor: col-resize;
      position: relative;
      transition: background 0.2s;
    }

    .divider:hover {
      background: var(--terminal-cyan);
      box-shadow: 0 0 10px var(--terminal-cyan);
    }

    .divider.dragging {
      background: var(--terminal-amber);
      box-shadow: 0 0 20px var(--terminal-amber);
    }

    .diff-panel {
      background: var(--bg-darker);
      overflow-y: auto;
      overflow-x: hidden;
      border-left: 2px solid var(--terminal-green);
    }

    .diff-panel::-webkit-scrollbar { width: 10px; }
    .diff-panel::-webkit-scrollbar-track { background: var(--bg-black); }
    .diff-panel::-webkit-scrollbar-thumb { background: var(--terminal-green); border-radius: 5px; }
    .diff-panel::-webkit-scrollbar-thumb:hover { background: var(--terminal-cyan); }

    .diff-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(0, 255, 65, 0.2);
      position: sticky;
      top: 0;
      background: var(--bg-darker);
      z-index: 10;
    }

    .diff-stats {
      font-size: 12px;
      color: var(--terminal-amber);
      margin-bottom: 8px;
    }

    .diff-message {
      padding: 40px 20px;
      text-align: center;
      color: rgba(0, 255, 65, 0.5);
      font-size: 13px;
    }

    .diff-error { color: var(--terminal-red); }

    .file-card {
      margin: 16px;
      border: 2px solid var(--terminal-green);
      background: var(--bg-dark);
    }

    .file-header {
      padding: 12px 16px;
      background: var(--bg-black);
      border-bottom: 1px solid var(--terminal-green);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }

    .file-header:hover { background: rgba(0, 255, 65, 0.05); }

    .file-name {
      color: var(--terminal-amber);
      font-size: 13px;
      font-weight: 700;
      flex: 1;
    }

    .file-stats {
      font-size: 11px;
      color: var(--terminal-cyan);
      margin-right: 12px;
    }

    .file-stats .additions { color: var(--terminal-green); }
    .file-stats .deletions { color: var(--terminal-red); }

    .expand-icon {
      color: var(--terminal-green);
      font-size: 16px;
      transition: transform 0.2s;
    }

    .file-card.collapsed .expand-icon { transform: rotate(-90deg); }
    .file-body { display: none; }
    .file-card:not(.collapsed) .file-body { display: block; }

    .file-status-badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 3px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 8px;
      flex-shrink: 0;
    }
    .file-status-untracked {
      background: rgba(0, 188, 212, 0.15);
      color: #00bcd4;
      border: 1px solid rgba(0, 188, 212, 0.3);
    }
    .file-status-new {
      background: rgba(0, 255, 65, 0.15);
      color: var(--terminal-green);
      border: 1px solid rgba(0, 255, 65, 0.3);
    }
    .file-status-deleted {
      background: rgba(255, 50, 50, 0.15);
      color: var(--terminal-red);
      border: 1px solid rgba(255, 50, 50, 0.3);
    }
    .file-status-renamed {
      background: rgba(255, 193, 7, 0.15);
      color: #ffc107;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .binary-notice {
      padding: 20px;
      text-align: center;
      color: rgba(0, 255, 65, 0.5);
      font-size: 12px;
    }

    .hunk { border-top: 1px solid rgba(0, 255, 65, 0.1); }

    .hunk-header {
      background: rgba(0, 255, 255, 0.1);
      padding: 8px 16px;
      color: var(--terminal-cyan);
      font-size: 11px;
      border-bottom: 1px solid rgba(0, 255, 255, 0.2);
    }

    .diff-table { width: 100%; font-size: 12px; border-collapse: collapse; }

    .diff-line { display: flex; }

    .line-number {
      padding: 2px 8px;
      text-align: right;
      color: rgba(0, 255, 65, 0.4);
      user-select: none;
      min-width: 50px;
      font-size: 11px;
    }

    .line-content {
      padding: 2px 12px;
      flex: 1;
      white-space: pre-wrap;
      word-break: break-all;
      font-size: 12px;
    }

    .line-addition { background: rgba(0, 255, 65, 0.15); }
    .line-addition .line-content { color: var(--terminal-green); }
    .line-deletion { background: rgba(255, 0, 0, 0.15); }
    .line-deletion .line-content { color: var(--terminal-red); }
    .line-context { background: transparent; }
    .line-context .line-content { color: rgba(0, 255, 65, 0.7); }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: rgba(0, 255, 65, 0.4);
      font-size: 14px;
      gap: 16px;
    }

    .empty-state .empty-hint {
      font-size: 12px;
      color: rgba(0, 255, 65, 0.25);
    }

    @media (max-width: 1024px) {
      .main-container {
        grid-template-columns: 1fr 6px 400px;
      }
    }

    @media (max-width: 768px) {
      .main-container {
        display: flex;
        flex-direction: column;
      }
      .main-container .diff-panel {
        display: none;
        width: 100%;
        border-left: none;
        border-top: 2px solid var(--terminal-green);
      }
      .main-container .divider { display: none; }
      .main-container .terminal-panel {
        width: 100% !important;
        flex: 1;
      }
      .main-container.collapsed .terminal-panel {
        width: 100% !important;
        flex: 1;
      }

      .main-container.mobile-diff-open .diff-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .main-container.mobile-diff-open .terminal-panel { display: none; }

      .folder-path {
        max-width: 150px;
      }

      .toolbar-btn, .collapse-btn { min-height: 44px; min-width: 44px; }

      .line-number { min-width: 35px; font-size: 11px; }
      .line-content { font-size: 12px; }
      .file-header { min-height: 44px; display: flex; align-items: center; }

      .tab { padding: 0 12px; }
    }

    /* Floating scroll-to-bottom button */
    .scroll-bottom-btn {
      position: absolute;
      bottom: 16px;
      right: 16px;
      width: 48px;
      height: 48px;
      border: 2px solid var(--terminal-green);
      background: var(--bg-black);
      color: var(--terminal-green);
      font-size: 24px;
      cursor: pointer;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s, background 0.1s, color 0.1s, transform 0.1s;
      z-index: 999;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .scroll-bottom-btn.visible { opacity: 0.9; visibility: visible; }
    .scroll-bottom-btn:hover { opacity: 1; background: var(--terminal-green); color: var(--bg-black); transform: scale(1.05); }
    .scroll-bottom-btn:active { transform: scale(0.95); }

    @media (max-width: 768px) {
      .scroll-bottom-btn {
        bottom: 62px;
        right: 12px;
        width: 44px;
        height: 44px;
        font-size: 22px;
      }
    }

    /* Touch scroll overlay */
    .touch-scroll-overlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
      touch-action: none;
      pointer-events: auto;
    }

    @media (max-width: 768px) {
      .touch-scroll-overlay { display: block; }
    }

    /* Mobile keyboard toolbar */
    .mobile-keyboard-toolbar { display: none; }

    @media (max-width: 768px) {
      .mobile-keyboard-toolbar {
        display: flex;
        flex-wrap: nowrap;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-dark);
        border-top: 1px solid rgba(0, 255, 65, 0.2);
        padding: 6px 8px;
        padding-bottom: max(6px, env(safe-area-inset-bottom));
        gap: 6px;
        z-index: 1000;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }

      .mobile-keyboard-toolbar button {
        flex-shrink: 0;
        min-width: 36px;
        padding: 6px 8px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(0, 255, 65, 0.25);
        border-radius: 6px;
        color: var(--terminal-green);
        font-size: 13px;
        cursor: pointer;
        transition: background 0.1s, transform 0.1s;
        font-family: 'JetBrains Mono', monospace;
        white-space: nowrap;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      .mobile-keyboard-toolbar button:active {
        background: rgba(0, 255, 65, 0.2);
        color: var(--terminal-green);
        transform: scale(0.92);
      }

      .main-container {
        height: calc(100vh - 90px - 46px);
      }
    }

    .drop-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 255, 65, 0.08);
      border: 3px dashed var(--terminal-green);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: var(--terminal-green);
      pointer-events: none;
    }
    .drop-overlay.visible { display: flex; pointer-events: auto; }

    /* Image preview panel */
    .img-preview-panel {
      display: none;
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: 320px;
      max-height: 400px;
      background: var(--bg-dark);
      border: 1px solid rgba(0, 255, 65, 0.3);
      border-radius: 6px;
      z-index: 5000;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    .img-preview-panel.visible { display: flex; }
    .img-preview-panel.minimized .img-preview-body { display: none; }

    .img-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid rgba(0, 255, 65, 0.15);
      font-size: 11px;
      color: var(--terminal-cyan);
      cursor: move;
      user-select: none;
      -webkit-user-select: none;
      flex-shrink: 0;
    }

    .img-preview-header-actions {
      display: flex;
      gap: 6px;
    }

    .img-preview-header-actions button {
      background: transparent;
      border: none;
      color: rgba(0, 255, 65, 0.6);
      cursor: pointer;
      font-size: 14px;
      padding: 2px 4px;
      line-height: 1;
      font-family: 'JetBrains Mono', monospace;
      transition: color 0.15s;
    }

    .img-preview-header-actions button:hover {
      color: var(--terminal-green);
    }

    .img-preview-body {
      padding: 8px;
      overflow: auto;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60px;
    }

    .img-preview-body img {
      max-width: 100%;
      max-height: 340px;
      border-radius: 4px;
      cursor: pointer;
      image-rendering: auto;
    }

    .img-preview-body .img-preview-empty {
      color: rgba(0, 255, 65, 0.3);
      font-size: 11px;
      text-align: center;
      padding: 20px;
    }

    .img-preview-filename {
      padding: 4px 12px 8px;
      font-size: 10px;
      color: rgba(0, 255, 65, 0.4);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Expanded overlay for clicking image */
    .img-preview-expanded {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 6000;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .img-preview-expanded.visible { display: flex; }

    .img-preview-expanded img {
      max-width: 95vw;
      max-height: 95vh;
      border-radius: 4px;
    }

    @media (max-width: 768px) {
      .img-preview-panel {
        bottom: 52px;
        right: 8px;
        left: 8px;
        width: auto;
      }
    }

  </style>
</head>
<body>
  <div class="toolbar">
    <a href="/" class="back-btn">&larr; Back</a>
    <div class="folder-path">{{FOLDER_PATH_HTML}}</div>
    <div class="toolbar-actions">
      <button id="refresh-btn" class="toolbar-btn">Refresh</button>
      <button id="auto-refresh-btn" class="toolbar-btn">Auto</button>
      <button id="collapse-btn" class="toolbar-btn">Collapse</button>
      <button id="upload-btn" class="toolbar-btn" title="Upload file to folder">Upload</button>
      <button id="img-preview-btn" class="toolbar-btn" title="Toggle image preview panel">Img</button>
    </div>
  </div>

  <div class="tab-bar" id="tab-bar">
    <div class="new-tab-wrapper" id="new-tab-wrapper">
      <button class="new-tab-btn" id="new-tab-btn">+ New</button>
      <div class="new-tab-dropdown" id="new-tab-dropdown"></div>
    </div>
  </div>

  <div class="main-container" id="main-container">
    <div class="drop-overlay" id="drop-overlay">Drop file to upload</div>
    <div class="terminal-panel" id="terminal-panel" style="position:relative;">
      <div class="empty-state" id="empty-state">
        <div>No sessions open</div>
        <div class="empty-hint">Click "+ New" to create a terminal session</div>
      </div>

      <!-- Hidden keyboard proxy for iOS focus (Mobile Only) -->
      <textarea
        id="keyboard-proxy"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
        inputmode="text"
        tabindex="-1"
        style="position:absolute;top:0;left:0;width:100%;height:44px;font-size:16px;opacity:0;z-index:9;touch-action:manipulation;resize:none;border:none;outline:none;background:transparent;color:transparent;caret-color:transparent;"
        aria-hidden="true"
      ></textarea>

      <!-- Touch Scroll Overlay (Mobile Only) -->
      <div id="touch-scroll-overlay" class="touch-scroll-overlay"></div>

      <!-- Scroll to Bottom Button -->
      <button id="scroll-bottom-btn" class="scroll-bottom-btn" title="Go to bottom">&darr;</button>

      <!-- Mobile Keyboard Toolbar -->
      <div class="mobile-keyboard-toolbar">
        <button data-action="paste-image" title="Paste Image">Img</button>
        <button data-key="esc" title="Escape">ESC</button>
        <button data-key="up" title="Up Arrow">&uarr;</button>
        <button data-key="down" title="Down Arrow">&darr;</button>
        <button data-key="left" title="Left Arrow">&larr;</button>
        <button data-key="right" title="Right Arrow">&rarr;</button>
        <button data-key="tab" title="Tab">&rarrb;</button>
        <button data-key="shift-tab" title="Shift+Tab">&larrb;</button>
        <button data-key="shift-enter" title="Shift+Enter">&crarr;</button>
        <button data-char="1" title="1">1</button>
        <button data-char="2" title="2">2</button>
        <button data-char="3" title="3">3</button>
        <button data-char="4" title="4">4</button>
        <button data-char="5" title="5">5</button>
        <button data-char="6" title="6">6</button>
        <button data-char="7" title="7">7</button>
        <button data-char="8" title="8">8</button>
        <button data-char="9" title="9">9</button>
        <button data-char="0" title="0">0</button>
      </div>
    </div>

    <div id="divider" class="divider"></div>

    <div class="diff-panel" id="diff-panel">
      <div class="diff-header">
        <div id="diff-stats" class="diff-stats">Loading...</div>
      </div>
      <div id="diff-content"></div>
    </div>
  </div>

  <div id="drag-overlay" class="drag-overlay"></div>

  <script nonce="{{NONCE}}">
    const FOLDER_PATH = '{{FOLDER_PATH_JS}}';
    const FOLDER_PATH_URL = '{{FOLDER_PATH_URL}}';
    const STORAGE_PREFIX = 'folder_' + FOLDER_PATH;

    let tabs = [];
    let activeTabId = null;
    let availableTools = [];
    let autoRefreshInterval = null;
    let currentDiffData = null;

    function escapeHtml(str) {
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ── LocalStorage helpers ──

    function loadStoredActiveTab() {
      return localStorage.getItem(STORAGE_PREFIX + '_activeTab');
    }

    function saveStoredActiveTab(id) {
      localStorage.setItem(STORAGE_PREFIX + '_activeTab', id);
    }

    // ── Tab Management ──

    function getActiveIframe() {
      var el = document.getElementById('terminal-iframe');
      return el;
    }

    function buildIframeSrc(session) {
      return '/terminal/' + encodeURIComponent(session.id) + '/';
    }

    function getBadgeLabel(session) {
      if (session.type === 'shell') return 'Shell';
      return session.tool || 'claude';
    }

    function createTabElement(session) {
      var tab = document.createElement('div');
      tab.className = 'tab';
      tab.dataset.sessionId = session.id;

      var nameSpan = document.createElement('span');
      nameSpan.className = 'tab-name';
      nameSpan.textContent = session.name;

      var badge = document.createElement('span');
      badge.className = 'tab-badge';
      badge.textContent = getBadgeLabel(session);

      var close = document.createElement('span');
      close.className = 'tab-close';
      close.textContent = '\u00d7';

      tab.appendChild(nameSpan);
      tab.appendChild(badge);
      tab.appendChild(close);

      return tab;
    }

    function createIframeElement(session) {
      var iframe = document.createElement('iframe');
      iframe.className = 'terminal-iframe';
      iframe.dataset.sessionId = session.id;
      iframe.src = buildIframeSrc(session);
      iframe.setAttribute('allow', 'clipboard-read; clipboard-write');
      return iframe;
    }

    function addTab(session, makeActive) {
      tabs.push(session);

      var tabEl = createTabElement(session);
      var wrapper = document.getElementById('new-tab-wrapper');
      wrapper.parentNode.insertBefore(tabEl, wrapper);

      var iframe = createIframeElement(session);
      document.getElementById('terminal-panel').appendChild(iframe);

      // Wire up iframe load for terminal redraw
      iframe.addEventListener('load', function() {
        setTimeout(function() {
          forceTerminalRedraw(iframe);
          attachScrollCheck(iframe);
          attachLineFeedListener(iframe);
          injectAutoReconnect(iframe);
        }, 1000);
      });

      if (makeActive) {
        switchToTab(session.id);
      }

      document.getElementById('empty-state').style.display = 'none';
    }

    function switchToTab(sessionId) {
      activeTabId = sessionId;
      saveStoredActiveTab(sessionId);

      // Update tab active state
      var allTabs = document.querySelectorAll('.tab');
      for (var i = 0; i < allTabs.length; i++) {
        if (allTabs[i].dataset.sessionId === sessionId) {
          allTabs[i].classList.add('active');
        } else {
          allTabs[i].classList.remove('active');
        }
      }

      // Update iframe visibility and terminal-iframe ID
      var iframes = document.querySelectorAll('.terminal-iframe');
      for (var j = 0; j < iframes.length; j++) {
        var isActive = iframes[j].dataset.sessionId === sessionId;
        if (isActive) {
          iframes[j].classList.add('active');
          iframes[j].id = 'terminal-iframe';
        } else {
          iframes[j].classList.remove('active');
          if (iframes[j].id === 'terminal-iframe') {
            iframes[j].id = '';
          }
        }
      }

      // Scroll active tab into view
      var activeTab = document.querySelector('.tab.active');
      if (activeTab) {
        activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
      }
    }

    function removeTab(sessionId) {
      // Remove from tabs array
      tabs = tabs.filter(function(t) { return t.id !== sessionId; });

      // Remove tab element
      var tabEl = document.querySelector('.tab[data-session-id="' + sessionId + '"]');
      if (tabEl) tabEl.remove();

      // Remove iframe
      var iframe = document.querySelector('.terminal-iframe[data-session-id="' + sessionId + '"]');
      if (iframe) iframe.remove();

      // If we removed the active tab, switch to another
      if (activeTabId === sessionId) {
        if (tabs.length > 0) {
          switchToTab(tabs[tabs.length - 1].id);
        } else {
          activeTabId = null;
          localStorage.removeItem(STORAGE_PREFIX + '_activeTab');
          document.getElementById('empty-state').style.display = '';
        }
      }
    }

    async function closeTab(sessionId) {
      try {
        var res = await fetch('/api/sessions/' + encodeURIComponent(sessionId), { method: 'DELETE' });
        if (!res.ok) {
          var data = await res.json();
          console.error('Failed to delete session:', data.error);
        }
      } catch (err) {
        console.error('Failed to delete session:', err);
      }
      removeTab(sessionId);
    }

    // ── New Tab ──

    function getNextName(baseName) {
      var existing = tabs.filter(function(t) {
        return t.name.startsWith(baseName);
      });
      var maxNum = 0;
      existing.forEach(function(t) {
        var match = t.name.match(new RegExp('^' + escapeRegex(baseName) + ' #(\\d+)$'));
        if (match) {
          var n = parseInt(match[1], 10);
          if (n > maxNum) maxNum = n;
        }
      });
      return baseName + ' #' + (maxNum + 1);
    }

    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    async function createNewTab(toolId, toolName, isShell) {
      var baseName = isShell ? 'Shell' : (toolName || toolId);
      var name = getNextName(baseName);

      var body = { name: name, folder: FOLDER_PATH };
      if (isShell) {
        body.type = 'shell';
      } else {
        body.tool = toolId;
      }

      try {
        var res = await fetch('/api/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        var data = await res.json();
        if (!res.ok) {
          console.error('Failed to create session:', data.error);
          return;
        }
        addTab(data.session, true);
      } catch (err) {
        console.error('Failed to create session:', err);
      }
    }

    function renderNewTabDropdown() {
      var dropdown = document.getElementById('new-tab-dropdown');
      var html = '';

      // Shell option first
      html += '<button class="new-tab-option" data-tool-id="shell" data-is-shell="true">';
      html += 'Shell <span class="option-label">terminal</span>';
      html += '</button>';

      // Available tools
      availableTools.forEach(function(tool) {
        if (!tool.available) return;
        html += '<button class="new-tab-option" data-tool-id="' + escapeHtml(tool.id) + '" data-tool-name="' + escapeHtml(tool.name) + '">';
        html += escapeHtml(tool.name) + ' <span class="option-label">' + escapeHtml(tool.id) + '</span>';
        html += '</button>';
      });

      dropdown.innerHTML = html;
    }

    // ── Diff Panel (same as session-view.html) ──

    async function fetchDiff() {
      var diffStats = document.getElementById('diff-stats');
      var diffContent = document.getElementById('diff-content');

      try {
        diffStats.textContent = 'Loading...';
        var res = await fetch('/api/diff?folder=' + encodeURIComponent(FOLDER_PATH));
        var data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Failed to fetch diff');
        }

        currentDiffData = data;
        renderDiffPanel(data);
      } catch (err) {
        console.error('Fetch diff error:', err);
        diffStats.textContent = 'Error';
        diffContent.innerHTML = '<div class="diff-message diff-error">Failed to load diff: ' + escapeHtml(err.message) + '</div>';
      }
    }

    function renderDiffPanel(data) {
      var diffStats = document.getElementById('diff-stats');
      var diffContent = document.getElementById('diff-content');

      if (!data.isGitRepo) {
        diffStats.textContent = 'Not a git repository';
        diffContent.innerHTML = '<div class="diff-message">This folder is not a git repository</div>';
        return;
      }

      if (data.error) {
        diffStats.textContent = 'Error';
        diffContent.innerHTML = '<div class="diff-message diff-error">' + escapeHtml(data.error) + '</div>';
        return;
      }

      if (!data.files || data.files.length === 0) {
        diffStats.textContent = 'No changes';
        diffContent.innerHTML = '<div class="diff-message">Working tree clean</div>';
        return;
      }

      var stats = data.stats;
      diffStats.innerHTML =
        '<span>' + stats.files + ' file' + (stats.files !== 1 ? 's' : '') + '</span> &bull; ' +
        '<span class="additions">+' + stats.additions + '</span> / ' +
        '<span class="deletions">-' + stats.deletions + '</span>';

      diffContent.innerHTML = data.files.map(function(file) {
        var fileId = 'file_' + Math.random().toString(36).substr(2, 9);
        return '<div class="file-card collapsed" id="' + fileId + '">' +
          '<div class="file-header" data-file-id="' + fileId + '">' +
            '<div class="file-name">' + escapeHtml(file.path) +
              (file.status && file.status !== 'modified'
                ? '<span class="file-status-badge file-status-' + file.status + '">' + file.status + '</span>'
                : '') +
            '</div>' +
            '<div class="file-stats">' +
              '<span class="additions">+' + file.additions + '</span> / ' +
              '<span class="deletions">-' + file.deletions + '</span>' +
            '</div>' +
            '<span class="expand-icon">\u25bc</span>' +
          '</div>' +
          '<div class="file-body">' +
            (file.isBinary
              ? '<div class="binary-notice">Binary file changed</div>'
              : file.hunks.map(renderHunk).join('')) +
          '</div>' +
        '</div>';
      }).join('');
    }

    function renderHunk(hunk) {
      var oldLineNum = hunk.oldStart;
      var newLineNum = hunk.newStart;

      var linesHtml = hunk.lines.map(function(line) {
        var oldNum = '';
        var newNum = '';
        var cssClass = '';

        if (line.type === 'addition') {
          newNum = newLineNum++;
          cssClass = 'line-addition';
        } else if (line.type === 'deletion') {
          oldNum = oldLineNum++;
          cssClass = 'line-deletion';
        } else {
          oldNum = oldLineNum++;
          newNum = newLineNum++;
          cssClass = 'line-context';
        }

        return '<div class="diff-line ' + cssClass + '">' +
          '<div class="line-number">' + oldNum + '</div>' +
          '<div class="line-number">' + newNum + '</div>' +
          '<div class="line-content">' + escapeHtml(line.content) + '</div>' +
        '</div>';
      }).join('');

      return '<div class="hunk">' +
        '<div class="hunk-header">@@ -' + hunk.oldStart + ',' + hunk.oldCount +
          ' +' + hunk.newStart + ',' + hunk.newCount + ' @@ ' + escapeHtml(hunk.header) + '</div>' +
        linesHtml +
      '</div>';
    }

    function toggleFile(fileId) {
      var card = document.getElementById(fileId);
      if (card) card.classList.toggle('collapsed');
    }

    document.getElementById('diff-content').addEventListener('click', function(e) {
      var header = e.target.closest('.file-header');
      if (header && header.dataset.fileId) {
        toggleFile(header.dataset.fileId);
      }
    });

    // ── Diff Panel Controls ──

    var savedWidth = localStorage.getItem(STORAGE_PREFIX + '_diffWidth');
    if (savedWidth) {
      document.documentElement.style.setProperty('--diff-panel-width', savedWidth + 'px');
    }

    var isCollapsed = localStorage.getItem(STORAGE_PREFIX + '_diffCollapsed') === 'true';
    if (window.innerWidth <= 768) {
      document.getElementById('collapse-btn').textContent = 'Diff';
    } else if (isCollapsed) {
      document.getElementById('main-container').classList.add('collapsed');
      document.getElementById('collapse-btn').textContent = 'Expand';
    }

    var autoRefreshEnabled = localStorage.getItem(STORAGE_PREFIX + '_autoRefresh') === 'true';
    if (autoRefreshEnabled) {
      startAutoRefresh();
      document.getElementById('auto-refresh-btn').classList.add('active');
    }

    document.getElementById('refresh-btn').addEventListener('click', function() {
      fetchDiff();
    });

    document.getElementById('auto-refresh-btn').addEventListener('click', function() {
      var btn = document.getElementById('auto-refresh-btn');
      if (autoRefreshInterval) {
        stopAutoRefresh();
        btn.classList.remove('active');
        localStorage.setItem(STORAGE_PREFIX + '_autoRefresh', 'false');
      } else {
        startAutoRefresh();
        btn.classList.add('active');
        localStorage.setItem(STORAGE_PREFIX + '_autoRefresh', 'true');
      }
    });

    function startAutoRefresh() {
      if (autoRefreshInterval) return;
      autoRefreshInterval = setInterval(function() { fetchDiff(); }, 10000);
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }

    document.getElementById('collapse-btn').addEventListener('click', function() {
      var container = document.getElementById('main-container');
      var btn = document.getElementById('collapse-btn');

      if (window.innerWidth <= 768) {
        var isDiffOpen = container.classList.contains('mobile-diff-open');
        if (isDiffOpen) {
          container.classList.remove('mobile-diff-open');
          btn.textContent = 'Diff';
        } else {
          container.classList.add('mobile-diff-open');
          btn.textContent = 'Terminal';
        }
        return;
      }

      var isCurrentlyCollapsed = container.classList.contains('collapsed');
      if (isCurrentlyCollapsed) {
        container.classList.remove('collapsed');
        btn.textContent = 'Collapse';
        localStorage.setItem(STORAGE_PREFIX + '_diffCollapsed', 'false');
      } else {
        container.classList.add('collapsed');
        btn.textContent = 'Expand';
        localStorage.setItem(STORAGE_PREFIX + '_diffCollapsed', 'true');
      }
    });

    // ── Draggable Resize ──

    var divider = document.getElementById('divider');
    var isDragging = false;
    var dragStartX = 0;
    var dragStartWidth = 0;

    divider.addEventListener('mousedown', function(e) {
      isDragging = true;
      dragStartX = e.clientX;
      dragStartWidth = document.getElementById('diff-panel').offsetWidth;
      divider.classList.add('dragging');
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';

      // Disable pointer events on all iframes during drag
      var iframes = document.querySelectorAll('.terminal-iframe');
      for (var i = 0; i < iframes.length; i++) {
        iframes[i].style.pointerEvents = 'none';
      }
      document.getElementById('drag-overlay').style.display = 'block';
      e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      var delta = dragStartX - e.clientX;
      var newWidth = Math.max(300, Math.min(dragStartWidth + delta, window.innerWidth - 300));
      document.documentElement.style.setProperty('--diff-panel-width', newWidth + 'px');
    });

    document.addEventListener('mouseup', function() {
      if (isDragging) {
        isDragging = false;
        divider.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';

        var iframes = document.querySelectorAll('.terminal-iframe');
        for (var i = 0; i < iframes.length; i++) {
          iframes[i].style.pointerEvents = '';
        }
        document.getElementById('drag-overlay').style.display = 'none';

        var diffPanel = document.getElementById('diff-panel');
        localStorage.setItem(STORAGE_PREFIX + '_diffWidth', diffPanel.offsetWidth);
      }
    });

    // ── Tab Bar Event Delegation ──

    document.getElementById('tab-bar').addEventListener('click', function(e) {
      // Close button
      var closeBtn = e.target.closest('.tab-close');
      if (closeBtn) {
        var tab = closeBtn.closest('.tab');
        if (tab && tab.dataset.sessionId) {
          closeTab(tab.dataset.sessionId);
        }
        return;
      }

      // Tab click (switch)
      var tabEl = e.target.closest('.tab');
      if (tabEl && tabEl.dataset.sessionId) {
        switchToTab(tabEl.dataset.sessionId);
        return;
      }

      // New tab button
      if (e.target.closest('#new-tab-btn')) {
        var dropdown = document.getElementById('new-tab-dropdown');
        var btn = document.getElementById('new-tab-btn');
        var rect = btn.getBoundingClientRect();
        dropdown.style.top = rect.bottom + 'px';
        dropdown.style.left = rect.left + 'px';
        dropdown.classList.toggle('open');
        return;
      }

      // New tab dropdown option
      var option = e.target.closest('.new-tab-option');
      if (option) {
        var dropdown = document.getElementById('new-tab-dropdown');
        dropdown.classList.remove('open');

        if (option.dataset.isShell === 'true') {
          createNewTab(null, null, true);
        } else {
          createNewTab(option.dataset.toolId, option.dataset.toolName, false);
        }
        return;
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#new-tab-wrapper')) {
        document.getElementById('new-tab-dropdown').classList.remove('open');
      }
    });

    // ── Terminal Helpers ──

    function injectAutoReconnect(iframe) {
      try {
        var doc = iframe.contentDocument || iframe.contentWindow.document;
        if (!doc || !doc.body) return;

        // ttyd's overlay is a plain div with inline styles and text like
        // "Press ⏎ to Reconnect". It has position:absolute and font-size:xx-large.
        // xterm.js listens for keys via its hidden textarea (.xterm-helper-textarea).
        function findReconnectOverlay() {
          var divs = doc.querySelectorAll('div[style*="position: absolute"][style*="font-size"]');
          for (var i = 0; i < divs.length; i++) {
            var text = divs[i].textContent || '';
            if (text.indexOf('Reconnect') !== -1) return divs[i];
          }
          return null;
        }

        function dismissOverlay() {
          var overlay = findReconnectOverlay();
          if (!overlay) return false;

          // Dispatch Enter on xterm's hidden textarea where terminal.onKey listens
          var textarea = doc.querySelector('.xterm-helper-textarea');
          if (textarea) {
            textarea.focus();
            var ev = new KeyboardEvent('keydown', {
              key: 'Enter', code: 'Enter', keyCode: 13, which: 13, bubbles: true
            });
            textarea.dispatchEvent(ev);
            return true;
          }
          return false;
        }

        // MutationObserver for immediate detection
        var observer = new MutationObserver(function() {
          setTimeout(function() { dismissOverlay(); }, 500);
        });
        observer.observe(doc.body, { childList: true, subtree: true });

        // Polling fallback every 2s (catches overlays present before observer attached)
        var pollId = setInterval(function() {
          try { dismissOverlay(); } catch (e) { clearInterval(pollId); }
        }, 2000);

        iframe._autoReconnectPoll = pollId;
      } catch (e) {}
    }

    function forceTerminalRedraw(iframe) {
      try {
        var term = iframe.contentWindow.term;
        if (!term || !term.cols || !term.rows) return;
        var cols = term.cols;
        var rows = term.rows;
        term.resize(cols - 1, rows);
        setTimeout(function() {
          try { term.resize(cols, rows); } catch (e) {}
        }, 50);
      } catch (e) {}
    }

    // ── Scroll-to-bottom button ──

    var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    var scrollCheckIntervals = {};

    function attachScrollCheck(iframe) {
      var sessionId = iframe.dataset.sessionId;
      if (scrollCheckIntervals[sessionId]) {
        clearInterval(scrollCheckIntervals[sessionId]);
      }

      var wasAtBottom = true;
      var lastBaseY = 0;

      var pollInterval = isMobile ? 150 : 500;
      scrollCheckIntervals[sessionId] = setInterval(function() {
        // Only check the active iframe
        if (activeTabId !== sessionId) return;

        try {
          var term = iframe.contentWindow.term;
          if (!term || !term.buffer || !term.buffer.active) return;

          var buf = term.buffer.active;
          var baseY = buf.baseY;
          var viewportY = buf.viewportY;
          var scrollBtn = document.getElementById('scroll-bottom-btn');

          if (isMobile && baseY > lastBaseY) {
            if (wasAtBottom) {
              term.scrollToBottom();
            }
            lastBaseY = baseY;
            wasAtBottom = buf.viewportY >= buf.baseY;
            if (wasAtBottom) {
              scrollBtn.classList.remove('visible');
            } else {
              scrollBtn.classList.add('visible');
            }
            return;
          }

          // Buffer reset detection (compaction clears buffer, baseY drops)
          if (baseY < lastBaseY) {
            term.scrollToBottom();
            lastBaseY = baseY;
            wasAtBottom = true;
            scrollBtn.classList.remove('visible');
            return;
          }

          // Auto-scroll desktop when user was at bottom and new content arrived
          if (baseY > lastBaseY && wasAtBottom) {
            term.scrollToBottom();
          }
          lastBaseY = baseY;
          wasAtBottom = viewportY >= baseY;

          if (viewportY < baseY) {
            scrollBtn.classList.add('visible');
          } else {
            scrollBtn.classList.remove('visible');
          }
        } catch (err) {}
      }, pollInterval);
    }

    var lineFeedDisposables = {};

    function attachLineFeedListener(iframe) {
      if (!isMobile) return;
      var sessionId = iframe.dataset.sessionId;
      if (lineFeedDisposables[sessionId]) return;

      try {
        var term = iframe.contentWindow.term;
        if (!term || typeof term.onLineFeed !== 'function') return;
        lineFeedDisposables[sessionId] = term.onLineFeed(function() {
          if (activeTabId !== sessionId) return;
          // Trigger scroll check
        });
      } catch (err) {}
    }

    document.getElementById('scroll-bottom-btn').addEventListener('click', function() {
      try {
        var iframe = document.getElementById('terminal-iframe');
        if (!iframe) return;
        var term = iframe.contentWindow.term;
        if (term && typeof term.scrollToBottom === 'function') {
          term.scrollToBottom();
          document.getElementById('scroll-bottom-btn').classList.remove('visible');
        }
      } catch (err) {
        console.error('Failed to scroll to bottom:', err);
      }
    });

    // ── Mobile Keyboard Toolbar ──

    (function initMobileKeyboard() {
      var toolbar = document.querySelector('.mobile-keyboard-toolbar');
      if (!toolbar) return;

      var keyMap = {
        'esc': '\x1b',
        'up': '\x1b[A',
        'down': '\x1b[B',
        'right': '\x1b[C',
        'left': '\x1b[D',
        'tab': '\t',
        'shift-tab': '\x1b[Z',
        'shift-enter': '\n'
      };

      toolbar.addEventListener('click', function(e) {
        var button = e.target.closest('button');
        if (!button) return;

        var sequence = null;
        if (button.dataset.key) {
          sequence = keyMap[button.dataset.key];
        } else if (button.dataset.char !== undefined) {
          sequence = button.dataset.char;
        }
        if (!sequence) return;

        try {
          var iframe = document.getElementById('terminal-iframe');
          if (!iframe) return;
          var term = iframe.contentWindow.term;

          if (term && typeof term.input === 'function') {
            term.input(sequence);
          }
        } catch (err) {
          console.error('Failed to send key to terminal:', err);
        }

        e.preventDefault();
      });
    })();

    // ── Momentum scrolling for mobile ──

    (function() {
      var overlay = document.getElementById('touch-scroll-overlay');
      if (!overlay) return;

      var touchStartY = 0;
      var touchStartTime = 0;
      var lastY = 0;
      var lastTime = 0;
      var velocitySamples = [];
      var momentumAnimationId = null;
      var pixelAccumulator = 0;
      var LINE_HEIGHT = 18;

      function getTerm() {
        try {
          var iframe = document.getElementById('terminal-iframe');
          return iframe && iframe.contentWindow && iframe.contentWindow.term;
        } catch (err) {
          return null;
        }
      }

      function scrollByPixels(deltaPixels) {
        pixelAccumulator += deltaPixels;
        var lines = Math.floor(Math.abs(pixelAccumulator) / LINE_HEIGHT);
        if (lines > 0) {
          var term = getTerm();
          if (!term || typeof term.scrollLines !== 'function') return;
          var scrollAmount = pixelAccumulator > 0 ? -lines : lines;
          term.scrollLines(scrollAmount);
          var remainder = Math.abs(pixelAccumulator) % LINE_HEIGHT;
          pixelAccumulator = (pixelAccumulator > 0 ? 1 : -1) * remainder;
        }
      }

      function cancelMomentum() {
        if (momentumAnimationId !== null) {
          cancelAnimationFrame(momentumAnimationId);
          momentumAnimationId = null;
        }
      }

      function isAtScrollBoundary() {
        var term = getTerm();
        if (!term || !term.buffer || !term.buffer.active) return false;
        var baseY = term.buffer.active.baseY;
        var viewportY = term.buffer.active.viewportY;
        return viewportY <= 0 || viewportY >= baseY;
      }

      function startMomentum(velocity) {
        var FRICTION = 0.95;
        var MIN_VELOCITY = 0.5;

        function animate() {
          if (isAtScrollBoundary() && Math.abs(velocity) < 5) {
            cancelMomentum();
            return;
          }
          velocity *= FRICTION;
          if (Math.abs(velocity) < MIN_VELOCITY) {
            cancelMomentum();
            return;
          }
          scrollByPixels(velocity);
          momentumAnimationId = requestAnimationFrame(animate);
        }

        cancelMomentum();
        momentumAnimationId = requestAnimationFrame(animate);
      }

      overlay.addEventListener('touchstart', function(e) {
        cancelMomentum();
        var touch = e.touches[0];
        touchStartY = touch.clientY;
        touchStartTime = Date.now();
        lastY = touch.clientY;
        lastTime = Date.now();
        velocitySamples = [];
        pixelAccumulator = 0;
      });

      overlay.addEventListener('touchmove', function(e) {
        e.preventDefault();
        var touch = e.touches[0];
        var currentY = touch.clientY;
        var currentTime = Date.now();
        var deltaY = currentY - lastY;
        var deltaTime = currentTime - lastTime;

        scrollByPixels(deltaY);

        if (deltaTime > 0) {
          velocitySamples.push({ velocity: deltaY / deltaTime * 16, time: currentTime });
          if (velocitySamples.length > 5) velocitySamples.shift();
        }

        lastY = currentY;
        lastTime = currentTime;
      });

      overlay.addEventListener('touchend', function(e) {
        var touchEndTime = Date.now();
        var touchDuration = touchEndTime - touchStartTime;
        var touchDistance = Math.abs(lastY - touchStartY);

        if (touchDistance < 10 && touchDuration < 300) {
          if (typeof window.focusKeyboardProxy === 'function') {
            window.focusKeyboardProxy();
            e.preventDefault();
          } else {
            var term = getTerm();
            if (term && typeof term.focus === 'function') term.focus();
          }
          return;
        }

        if (velocitySamples.length > 0) {
          var recentSamples = velocitySamples.filter(function(s) { return touchEndTime - s.time < 100; });
          if (recentSamples.length > 0) {
            var avgVelocity = recentSamples.reduce(function(sum, s) { return sum + s.velocity; }, 0) / recentSamples.length;
            if (Math.abs(avgVelocity) > 1) startMomentum(avgVelocity);
          }
        }
      });

      overlay.addEventListener('touchcancel', function() {
        cancelMomentum();
      });
    })();

    // ── Keyboard proxy for iOS ──

    (function initKeyboardProxy() {
      if (!isMobile) return;

      var proxy = document.getElementById('keyboard-proxy');
      if (!proxy) return;

      function getTerm() {
        try {
          var iframe = document.getElementById('terminal-iframe');
          return iframe && iframe.contentWindow && iframe.contentWindow.term;
        } catch (e) {
          return null;
        }
      }

      window.focusKeyboardProxy = function() {
        proxy.value = ' ';
        proxy.focus();
        proxy.setSelectionRange(1, 1);
      };

      proxy.addEventListener('beforeinput', function(e) {
        var term = getTerm();
        if (!term || typeof term.input !== 'function') return;

        if (e.inputType === 'deleteContentBackward') {
          e.preventDefault();
          proxy.value = ' ';
          term.input('\x7f', true);
        } else if (e.inputType === 'deleteContentForward') {
          e.preventDefault();
          proxy.value = ' ';
          term.input('\x1b[3~', true);
        }
      });

      proxy.addEventListener('input', function(e) {
        if (e.isComposing) return;
        var text = proxy.value;
        if (!text || text === ' ') { proxy.value = ' '; return; }
        var clean = text.startsWith(' ') ? text.slice(1) : text;
        proxy.value = ' ';
        if (!clean) return;
        var term = getTerm();
        if (term && typeof term.input === 'function') {
          term.input(clean, true);
        }
      });

      proxy.addEventListener('keydown', function(e) {
        var term = getTerm();
        if (!term || typeof term.input !== 'function') return;

        var sequence = null;
        switch (e.key) {
          case 'Enter':      sequence = e.shiftKey ? '\n' : '\r'; break;
          case 'Backspace':  sequence = '\x7f'; break;
          case 'Escape':     sequence = '\x1b'; break;
          case 'Tab':        sequence = e.shiftKey ? '\x1b[Z' : '\t'; break;
          case 'ArrowUp':    sequence = '\x1b[A'; break;
          case 'ArrowDown':  sequence = '\x1b[B'; break;
          case 'ArrowRight': sequence = '\x1b[C'; break;
          case 'ArrowLeft':  sequence = '\x1b[D'; break;
          case 'Home':       sequence = '\x1b[H'; break;
          case 'End':        sequence = '\x1b[F'; break;
          case 'Delete':     sequence = '\x1b[3~'; break;
        }

        if (sequence !== null) {
          e.preventDefault();
          proxy.value = ' ';
          term.input(sequence, true);
        }
      });

      proxy.addEventListener('compositionend', function(e) {
        var text = e.data || proxy.value;
        proxy.value = '';
        if (!text) return;
        var term = getTerm();
        if (term && typeof term.input === 'function') {
          term.input(text, true);
        }
      });

      // Visual viewport resize handling for iOS keyboard
      if (window.visualViewport) {
        var mainContainer = document.getElementById('main-container');
        var keyboardToolbar = document.querySelector('.mobile-keyboard-toolbar');
        var scrollBottomBtn = document.getElementById('scroll-bottom-btn');
        var topToolbarHeight = 90; // toolbar + tab bar
        var keyboardThreshold = 100;
        var rafId = null;
        var settleTimer = null;

        function applyLayout() {
          var savedViewportY = null;
          try {
            var termIframe = document.getElementById('terminal-iframe');
            var term = termIframe && termIframe.contentWindow && termIframe.contentWindow.term;
            if (term && term.buffer && term.buffer.active) {
              savedViewportY = term.buffer.active.viewportY;
            }
          } catch (e) {}

          var vvHeight = window.visualViewport.height;
          var fullHeight = window.innerHeight;
          var keyboardHeight = fullHeight - vvHeight;
          var keyboardOpen = keyboardHeight > keyboardThreshold;

          document.body.classList.toggle('keyboard-open', keyboardOpen);

          if (keyboardOpen) {
            var toolbarH = keyboardToolbar ? keyboardToolbar.offsetHeight : 0;
            var available = vvHeight - topToolbarHeight - toolbarH;
            mainContainer.style.height = available + 'px';
            if (keyboardToolbar) keyboardToolbar.style.bottom = keyboardHeight + 'px';
            if (scrollBottomBtn) scrollBottomBtn.style.bottom = '8px';
          } else {
            mainContainer.style.height = '';
            if (keyboardToolbar) keyboardToolbar.style.bottom = '';
            if (scrollBottomBtn) scrollBottomBtn.style.bottom = '';
          }

          if (savedViewportY !== null) {
            requestAnimationFrame(function() {
              try {
                var termIframe = document.getElementById('terminal-iframe');
                var term = termIframe && termIframe.contentWindow && termIframe.contentWindow.term;
                if (term && term.buffer && term.buffer.active) {
                  var delta = savedViewportY - term.buffer.active.viewportY;
                  if (delta !== 0) term.scrollLines(delta);
                }
              } catch (e) {}
            });
          }
        }

        function scheduleLayout() {
          if (rafId) cancelAnimationFrame(rafId);
          rafId = requestAnimationFrame(function() {
            rafId = null;
            applyLayout();
          });
          if (settleTimer) clearTimeout(settleTimer);
          settleTimer = setTimeout(function() {
            settleTimer = null;
            applyLayout();
          }, 350);
        }

        window.visualViewport.addEventListener('resize', scheduleLayout);
        window.visualViewport.addEventListener('scroll', scheduleLayout);
      }
    })();

    // ── Desktop Shift+Enter support ──

    (function initDesktopShiftEnter() {
      if (isMobile) return;

      // Attach to each iframe as it loads (handled in addTab via iframe load listener)
      // Also attach to any already-active iframe
      function attachToIframe(iframe) {
        function tryAttach() {
          try {
            var term = iframe.contentWindow && iframe.contentWindow.term;
            if (!term) { setTimeout(tryAttach, 500); return; }
            term.attachCustomKeyEventHandler(function(e) {
              if (e.type === 'keydown' && e.key === 'Enter' && e.shiftKey) {
                e.preventDefault();
                term.input('\n');
                return false;
              }
              return true;
            });

            // Listen for paste events on iframe document to catch images (works in Safari)
            var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.addEventListener('paste', function(e) {
              var items = e.clipboardData && e.clipboardData.items;
              if (!items) return;
              for (var i = 0; i < items.length; i++) {
                if (items[i].type.startsWith('image/')) {
                  e.preventDefault();
                  e.stopImmediatePropagation();
                  if (window.parent._clipboardImageUpload) {
                    window.parent._clipboardImageUpload(items[i].getAsFile(), term);
                  }
                  return;
                }
              }
              // Fallback: upload any pasted file (non-image) to the folder
              for (var j = 0; j < items.length; j++) {
                if (items[j].kind === 'file') {
                  var file = items[j].getAsFile();
                  if (file && window.parent._uploadFile) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    window.parent._uploadFile(file);
                    return;
                  }
                }
              }
            }, true);
          } catch (err) { setTimeout(tryAttach, 500); }
        }

        iframe.addEventListener('load', function() {
          setTimeout(tryAttach, 1000);
        });
        // Also try immediately in case iframe is already loaded
        setTimeout(tryAttach, 500);
      }

      // Observe new iframes added to terminal-panel
      var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(m) {
          m.addedNodes.forEach(function(node) {
            if (node.tagName === 'IFRAME' && node.classList.contains('terminal-iframe')) {
              attachToIframe(node);
            }
          });
        });
      });
      observer.observe(document.getElementById('terminal-panel'), { childList: true });
    })();

    // ── Cleanup on unload ──

    window.addEventListener('beforeunload', function() {
      Object.keys(scrollCheckIntervals).forEach(function(key) {
        clearInterval(scrollCheckIntervals[key]);
      });
      Object.keys(lineFeedDisposables).forEach(function(key) {
        if (lineFeedDisposables[key] && lineFeedDisposables[key].dispose) {
          lineFeedDisposables[key].dispose();
        }
      });
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    });

    // ── Initial Load ──

    (async function init() {
      // Fetch tools and sessions in parallel
      var toolsPromise = fetch('/api/tools').then(function(r) { return r.json(); });
      var sessionsPromise = fetch('/api/sessions?folder=' + encodeURIComponent(FOLDER_PATH))
        .then(function(r) { return r.json(); });

      try {
        var results = await Promise.all([toolsPromise, sessionsPromise]);
        var toolsData = results[0];
        var sessionsData = results[1];

        availableTools = toolsData.tools || [];
        renderNewTabDropdown();

        var sessions = sessionsData.sessions || [];
        var storedActiveId = loadStoredActiveTab();
        var hasStoredActive = sessions.some(function(s) { return s.id === storedActiveId; });

        sessions.forEach(function(session, index) {
          var shouldActivate = hasStoredActive
            ? session.id === storedActiveId
            : index === 0;
          addTab(session, shouldActivate);
        });

        if (sessions.length === 0) {
          document.getElementById('empty-state').style.display = '';
        }
      } catch (err) {
        console.error('Failed to initialize:', err);
      }

      fetchDiff();
    })();

    // Clipboard image paste interception
    (function() {
      function blobToBase64(blob) {
        return new Promise(function(resolve) {
          var reader = new FileReader();
          reader.onloadend = function() { resolve(reader.result); };
          reader.readAsDataURL(blob);
        });
      }

      function showToast(msg, isError) {
        var el = document.createElement('div');
        el.textContent = msg;
        el.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);' +
          'background:' + (isError ? '#ff0000' : '#00ff41') + ';color:#0a0a0a;' +
          'padding:6px 16px;font-family:JetBrains Mono,monospace;font-size:12px;' +
          'z-index:99999;border-radius:2px;';
        document.body.appendChild(el);
        setTimeout(function() { el.remove(); }, 2000);
      }

      function uploadAndPasteImage(blob, term) {
        showToast('Uploading image...');
        blobToBase64(blob).then(function(base64) {
          return fetch('/api/clipboard-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: base64 })
          });
        }).then(function(res) {
          if (!res.ok) throw new Error('Upload failed');
          if (term && typeof term.input === 'function') {
            term.input('\x1b[200~\x1b[201~', true);
          }
          showToast('Image pasted');
        }).catch(function(err) {
          console.error('Image paste failed:', err);
          showToast('Image paste failed', true);
        });
      }

      // Expose upload function for iframe paste handlers
      window._clipboardImageUpload = uploadAndPasteImage;

      // General file upload (drag-drop, button, paste fallback)
      var MAX_UPLOAD_SIZE = 25 * 1024 * 1024;

      function typeIntoTerminal(text) {
        var iframe = document.querySelector('.terminal-iframe.active');
        if (!iframe) return;
        try {
          var term = iframe.contentWindow && iframe.contentWindow.term;
          if (term && typeof term.input === 'function') {
            term.input(text, true);
          }
        } catch (e) {
          console.error('typeIntoTerminal failed:', e);
        }
      }

      function uploadFile(file) {
        if (file.size > MAX_UPLOAD_SIZE) {
          showToast('File too large (max 25 MB)', true);
          return;
        }
        showToast('Uploading ' + file.name + '...');
        fetch('/api/upload-file', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/octet-stream',
            'X-Filename': file.name
          },
          body: file
        }).then(function(res) {
          return res.json().then(function(data) { return { ok: res.ok, data: data }; });
        }).then(function(result) {
          if (!result.ok) throw new Error(result.data.error || 'Upload failed');
          showToast('Saved: ' + result.data.path);
          typeIntoTerminal('@' + result.data.path + ' ');
        }).catch(function(err) {
          showToast('Upload failed: ' + err.message, true);
        });
      }
      window._uploadFile = uploadFile;

      // Upload button
      var uploadBtn = document.getElementById('upload-btn');
      if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
          var input = document.createElement('input');
          input.type = 'file';
          input.multiple = true;
          input.addEventListener('change', function() {
            for (var i = 0; i < input.files.length; i++) {
              uploadFile(input.files[i]);
            }
          });
          input.click();
        });
      }

      // Drag-and-drop file upload
      //
      // Problem: terminal iframes are separate browsing contexts that swallow drag
      // events. The parent page never sees dragenter when dragging over an iframe.
      //
      // Solution: since iframes are same-origin (/terminal/...), we inject drag
      // listeners into each iframe's contentWindow. When the iframe detects a drag,
      // it posts a message to the parent. The parent then shows the overlay (which
      // is position:fixed over everything with z-index:9999 and pointer-events:auto)
      // so it can receive the drop.
      //
      // No drag-catcher div or mouse-event forwarding needed. Terminal mouse
      // interaction is completely unaffected.
      (function initDropZone() {
        var overlay = document.getElementById('drop-overlay');
        var hideTimer = null;

        function showOverlay() {
          overlay.classList.add('visible');
          resetHideTimer();
        }

        function hideOverlay() {
          overlay.classList.remove('visible');
          clearHideTimer();
        }

        function resetHideTimer() {
          clearHideTimer();
          // Safety: if no dragover for 300ms, the drag left without a clean dragleave
          hideTimer = setTimeout(hideOverlay, 300);
        }

        function clearHideTimer() {
          if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
        }

        function handleDrop(e) {
          e.preventDefault();
          hideOverlay();
          var files = e.dataTransfer && e.dataTransfer.files;
          if (files) {
            for (var i = 0; i < files.length; i++) { uploadFile(files[i]); }
          }
        }

        // --- Detect drags from non-iframe areas ---
        document.addEventListener('dragenter', function(e) { e.preventDefault(); showOverlay(); });
        document.addEventListener('dragover', function(e) { e.preventDefault(); });
        document.addEventListener('drop', function(e) { e.preventDefault(); handleDrop(e); });

        // --- Overlay handles its own dismissal ---
        overlay.addEventListener('dragover', function(e) {
          e.preventDefault();
          resetHideTimer(); // drag still active, keep overlay visible
        });
        overlay.addEventListener('dragleave', function(e) {
          e.preventDefault();
          // Only hide when drag truly leaves the viewport (relatedTarget is null)
          // not when crossing into a child text node inside the overlay
          if (!e.relatedTarget) { hideOverlay(); }
        });
        overlay.addEventListener('drop', handleDrop);

        // --- Detect drags from iframes via postMessage ---
        window.addEventListener('message', function(e) {
          if (!e.data || e.data.type !== 'iframe-drag') return;
          if (e.data.event === 'dragenter') { showOverlay(); }
          // Once overlay is visible, it handles its own dismissal
        });

        // Inject drag listeners into each iframe once it loads.
        // Retry on existing iframes in case they're already loaded.
        function injectDragListeners(iframe) {
          if (iframe._dragInjected) return;
          try {
            var win = iframe.contentWindow;
            var doc = win && win.document;
            if (!doc || !doc.body) return;
            iframe._dragInjected = true;

            win.addEventListener('dragenter', function(e) {
              e.preventDefault();
              parent.postMessage({ type: 'iframe-drag', event: 'dragenter' }, '*');
            });
            win.addEventListener('dragover', function(e) {
              e.preventDefault();
            });
            win.addEventListener('dragleave', function(e) {
              e.preventDefault();
              parent.postMessage({ type: 'iframe-drag', event: 'dragleave' }, '*');
            });
            win.addEventListener('drop', function(e) {
              e.preventDefault();
              parent.postMessage({ type: 'iframe-drag', event: 'drop' }, '*');
            });
          } catch (err) {
            // Cross-origin iframe -- can't inject. Drag over it won't work.
          }
        }

        // Inject into existing iframes
        function injectAll() {
          var iframes = document.querySelectorAll('.terminal-iframe');
          for (var i = 0; i < iframes.length; i++) {
            injectDragListeners(iframes[i]);
          }
        }
        injectAll();

        // Watch for new iframes being added to the DOM
        var observer = new MutationObserver(function(mutations) {
          for (var i = 0; i < mutations.length; i++) {
            var nodes = mutations[i].addedNodes;
            for (var j = 0; j < nodes.length; j++) {
              if (nodes[j].tagName === 'IFRAME' && nodes[j].classList.contains('terminal-iframe')) {
                nodes[j].addEventListener('load', function() {
                  injectDragListeners(this);
                });
                // Also try immediately in case it's already loaded
                injectDragListeners(nodes[j]);
              }
            }
          }
        });
        observer.observe(document.getElementById('terminal-panel'), { childList: true });

        // Retry injection for iframes that may not have finished loading yet
        setTimeout(injectAll, 1000);
        setTimeout(injectAll, 3000);
      })();

      // Mobile "Img" button handler -- uses async clipboard API (may not work in Safari)
      var toolbar = document.querySelector('.mobile-keyboard-toolbar');
      if (toolbar) {
        toolbar.addEventListener('click', function(e) {
          var btn = e.target.closest('[data-action="paste-image"]');
          if (!btn) return;
          e.preventDefault();
          var iframe = document.getElementById('terminal-iframe');
          var term = iframe && iframe.contentWindow && iframe.contentWindow.term;
          if (navigator.clipboard && navigator.clipboard.read) {
            navigator.clipboard.read().then(function(items) {
              for (var j = 0; j < items.length; j++) {
                var imgType = items[j].types.find(function(t) { return t.startsWith('image/'); });
                if (imgType) {
                  items[j].getType(imgType).then(function(blob) { uploadAndPasteImage(blob, term); });
                  return;
                }
              }
              showToast('No image in clipboard', true);
            }).catch(function() { showToast('Clipboard access denied', true); });
          } else {
            showToast('Clipboard API not available', true);
          }
        });
      }
    })();
  </script>

  <!-- Image preview panel -->
  <div class="img-preview-panel" id="img-preview-panel">
    <div class="img-preview-header" id="img-preview-drag-handle">
      <span>Image Preview</span>
      <div class="img-preview-header-actions">
        <button id="img-preview-minimize" title="Minimize">&minus;</button>
        <button id="img-preview-close" title="Close">&times;</button>
      </div>
    </div>
    <div class="img-preview-body" id="img-preview-body">
      <div class="img-preview-empty">Waiting for image...</div>
    </div>
    <div class="img-preview-filename" id="img-preview-filename"></div>
  </div>

  <div class="img-preview-expanded" id="img-preview-expanded">
    <img id="img-preview-expanded-img" src="" alt="Expanded preview">
  </div>

  <script nonce="{{NONCE}}">
    (async function() {
      const panel = document.getElementById('img-preview-panel');
      const body = document.getElementById('img-preview-body');
      const filenameEl = document.getElementById('img-preview-filename');
      const toggleBtn = document.getElementById('img-preview-btn');
      const minimizeBtn = document.getElementById('img-preview-minimize');
      const closeBtn = document.getElementById('img-preview-close');
      const expanded = document.getElementById('img-preview-expanded');
      const expandedImg = document.getElementById('img-preview-expanded-img');
      const dragHandle = document.getElementById('img-preview-drag-handle');

      let eventSource = null;
      let currentImgSrc = null;
      const FOLDER_PATH_URL = encodeURIComponent('{{FOLDER_PATH_JS}}');

      function showPanel() {
        panel.classList.add('visible');
        panel.classList.remove('minimized');
        toggleBtn.classList.add('active');
        connectSSE();
        fetchLatest();
      }

      function hidePanel() {
        panel.classList.remove('visible');
        toggleBtn.classList.remove('active');
        disconnectSSE();
      }

      async function configureHook(enable) {
        const r = await fetch('/api/image-preview/hook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ folder: '{{FOLDER_PATH_JS}}', enable: enable })
        });
        return r.json();
      }

      async function togglePanel() {
        if (panel.classList.contains('visible')) {
          try { await configureHook(false); } catch {}
          hidePanel();
        } else {
          try {
            await configureHook(true);
            showPanel();
          } catch {}
        }
      }

      toggleBtn.addEventListener('click', togglePanel);

      // Check hook status on page load and auto-show if enabled
      try {
        const r = await fetch('/api/image-preview/hook?folder=' + FOLDER_PATH_URL);
        const data = await r.json();
        if (data.enabled) showPanel();
      } catch {}
      closeBtn.addEventListener('click', hidePanel);

      minimizeBtn.addEventListener('click', function() {
        panel.classList.toggle('minimized');
      });

      // Expanded overlay
      expanded.addEventListener('click', function() {
        expanded.classList.remove('visible');
      });

      function displayImage(filePath) {
        const src = '/api/image-preview/file?folder=' + FOLDER_PATH_URL + '&path=' + encodeURIComponent(filePath);
        currentImgSrc = src;

        const img = document.createElement('img');
        img.src = src;
        img.alt = filePath.split('/').pop();
        img.addEventListener('click', function() {
          expandedImg.src = src;
          expanded.classList.add('visible');
        });

        body.replaceChildren(img);
        filenameEl.textContent = filePath;

        // Un-minimize when new image arrives
        panel.classList.remove('minimized');
      }

      async function fetchLatest() {
        try {
          const r = await fetch('/api/image-preview/latest?folder=' + FOLDER_PATH_URL);
          const data = await r.json();
          if (data && data.filePath) displayImage(data.filePath);
        } catch {}
      }

      function connectSSE() {
        if (eventSource) return;
        eventSource = new EventSource('/api/image-preview/events?folder=' + FOLDER_PATH_URL);
        eventSource.addEventListener('message', function(e) {
          try {
            const data = JSON.parse(e.data);
            if (data.filePath) {
              displayImage(data.filePath);
              // Auto-show panel if hidden
              if (!panel.classList.contains('visible')) showPanel();
            }
          } catch {}
        });
        eventSource.addEventListener('error', function() {
          disconnectSSE();
          setTimeout(function() {
            if (panel.classList.contains('visible')) connectSSE();
          }, 3000);
        });
      }

      function disconnectSSE() {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
        }
      }

      // Drag support for the panel header
      (function() {
        let dragging = false;
        let offsetX = 0, offsetY = 0;

        dragHandle.addEventListener('mousedown', function(e) {
          if (e.target.tagName === 'BUTTON') return;
          dragging = true;
          offsetX = e.clientX - panel.getBoundingClientRect().left;
          offsetY = e.clientY - panel.getBoundingClientRect().top;
          e.preventDefault();
        });

        document.addEventListener('mousemove', function(e) {
          if (!dragging) return;
          panel.style.left = (e.clientX - offsetX) + 'px';
          panel.style.top = (e.clientY - offsetY) + 'px';
          panel.style.right = 'auto';
          panel.style.bottom = 'auto';
        });

        document.addEventListener('mouseup', function() {
          dragging = false;
        });
      })();
    })();
  </script>
</body>
</html>
